{"version":3,"sources":["../../src/bindings/repl.ts","../../src/debug.ts","../../src/bindings/edge.ts","../../providers/cache_provider.ts"],"sourcesContent":["/*\n * @adonisjs/cache\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport type { Repl } from '@adonisjs/core/repl'\nimport type { ApplicationService } from '@adonisjs/core/types'\n\n/**\n * Helper to define REPL state\n */\nfunction setupReplState(repl: any, key: string, value: any) {\n  repl.server.context[key] = value\n  repl.notify(\n    `Loaded ${key} module. You can access it using the \"${repl.colors.underline(key)}\" variable`\n  )\n}\n\n/**\n * Define REPL bindings\n */\nexport function defineReplBindings(app: ApplicationService, Repl: Repl) {\n  /**\n   * Load cache provider to the cache property\n   */\n  Repl.addMethod(\n    'loadCache',\n    async (repl) => setupReplState(repl, 'cache', await app.container.make('cache.manager')),\n    { description: 'Load cache provider to the \"cache\" property' }\n  )\n}\n","/*\n * @adonisjs/drive\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport { debuglog } from 'node:util'\n\nexport default debuglog('adonisjs:cache')\n","/*\n * @adonisjs/cache\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport debug from '../debug.js'\nimport { CacheService } from '../types.js'\n\nexport async function registerViewBindings(manager: CacheService) {\n  const edge = await import('edge.js')\n  debug('detected edge installation. Registering cache global helpers')\n\n  edge.default.global('cache', manager)\n}\n","/*\n * @adonisjs/cache\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport type { ApplicationService } from '@adonisjs/core/types'\n\nimport { defineConfig } from '../index.js'\nimport type { CacheEvents } from 'bentocache/types'\nimport type { CacheService } from '../src/types.js'\nimport { defineReplBindings } from '../src/bindings/repl.js'\nimport { registerViewBindings } from '../src/bindings/edge.js'\n\n/**\n * Extend Adonis.js types to include cache\n */\ndeclare module '@adonisjs/core/types' {\n  /**\n   * Adding cache type to the application container\n   */\n  export interface ContainerBindings {\n    'cache.manager': CacheService\n  }\n\n  /**\n   * Add cache events to the application events list\n   */\n  export interface EventsList {\n    'cache:cleared': CacheEvents['cache:cleared']\n    'cache:deleted': CacheEvents['cache:deleted']\n    'cache:hit': CacheEvents['cache:hit']\n    'cache:miss': CacheEvents['cache:miss']\n    'cache:written': CacheEvents['cache:written']\n    'bus:message:published': CacheEvents['bus:message:published']\n    'bus:message:received': CacheEvents['bus:message:received']\n  }\n}\n\n/**\n * Cache provider to register cache specific bindings\n */\nexport default class CacheProvider {\n  constructor(protected app: ApplicationService) {}\n\n  /**\n   * Register the cache manager to the container\n   */\n  async #registerCacheManager() {\n    const cacheConfig = this.app.config.get<ReturnType<typeof defineConfig>>('cache')\n\n    this.app.container.singleton('cache.manager', async () => {\n      const { BentoCache } = await import('bentocache')\n      const emitter = await this.app.container.make('emitter')\n\n      /**\n       * Resolve all store config providers\n       */\n      const resolvedStores = Object.entries(cacheConfig.stores).map(async ([name, store]) => {\n        return [name, await store.entry().resolver(this.app)]\n      })\n\n      return new BentoCache({\n        ...cacheConfig,\n        emitter: emitter as any,\n        default: cacheConfig.default,\n        stores: Object.fromEntries(await Promise.all(resolvedStores)),\n      })\n    })\n  }\n\n  /**\n   * Register REPL bindings\n   */\n  async #registerReplBindings() {\n    if (this.app.getEnvironment() !== 'repl') {\n      return\n    }\n\n    const repl = await this.app.container.make('repl')\n    defineReplBindings(this.app, repl)\n  }\n\n  /**\n   * Register edge bindings\n   */\n  async #registerEdgeBindings() {\n    if (!this.app.usingEdgeJS) return\n\n    const manager = await this.app.container.make('cache.manager')\n    await registerViewBindings(manager)\n  }\n\n  /**\n   * Register bindings\n   */\n  async register() {\n    await this.#registerCacheManager()\n    await this.#registerReplBindings()\n    await this.#registerEdgeBindings()\n  }\n\n  /**\n   * Gracefully shutdown connections when app goes down\n   */\n  async shutdown() {\n    try {\n      const cache = await this.app.container.make('cache.manager')\n      await cache.disconnectAll()\n    } catch (_e) {\n      // Ignore errors\n    }\n  }\n}\n"],"mappings":";;;AAeA,SAAS,eAAe,MAAW,KAAa,OAAY;AAC1D,OAAK,OAAO,QAAQ,GAAG,IAAI;AAC3B,OAAK;AAAA,IACH,UAAU,GAAG,yCAAyC,KAAK,OAAO,UAAU,GAAG,CAAC;AAAA,EAClF;AACF;AAKO,SAAS,mBAAmB,KAAyB,MAAY;AAItE,OAAK;AAAA,IACH;AAAA,IACA,OAAO,SAAS,eAAe,MAAM,SAAS,MAAM,IAAI,UAAU,KAAK,eAAe,CAAC;AAAA,IACvF,EAAE,aAAa,8CAA8C;AAAA,EAC/D;AACF;;;ACzBA,SAAS,gBAAgB;AAEzB,IAAO,gBAAQ,SAAS,gBAAgB;;;ACCxC,eAAsB,qBAAqB,SAAuB;AAChE,QAAM,OAAO,MAAM,OAAO,SAAS;AACnC,gBAAM,8DAA8D;AAEpE,OAAK,QAAQ,OAAO,SAAS,OAAO;AACtC;;;AC4BA,IAAqB,gBAArB,MAAmC;AAAA,EACjC,YAAsB,KAAyB;AAAzB;AAAA,EAA0B;AAAA;AAAA;AAAA;AAAA,EAKhD,MAAM,wBAAwB;AAC5B,UAAM,cAAc,KAAK,IAAI,OAAO,IAAqC,OAAO;AAEhF,SAAK,IAAI,UAAU,UAAU,iBAAiB,YAAY;AACxD,YAAM,EAAE,WAAW,IAAI,MAAM,OAAO,YAAY;AAChD,YAAM,UAAU,MAAM,KAAK,IAAI,UAAU,KAAK,SAAS;AAKvD,YAAM,iBAAiB,OAAO,QAAQ,YAAY,MAAM,EAAE,IAAI,OAAO,CAAC,MAAM,KAAK,MAAM;AACrF,eAAO,CAAC,MAAM,MAAM,MAAM,MAAM,EAAE,SAAS,KAAK,GAAG,CAAC;AAAA,MACtD,CAAC;AAED,aAAO,IAAI,WAAW;AAAA,QACpB,GAAG;AAAA,QACH;AAAA,QACA,SAAS,YAAY;AAAA,QACrB,QAAQ,OAAO,YAAY,MAAM,QAAQ,IAAI,cAAc,CAAC;AAAA,MAC9D,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,wBAAwB;AAC5B,QAAI,KAAK,IAAI,eAAe,MAAM,QAAQ;AACxC;AAAA,IACF;AAEA,UAAM,OAAO,MAAM,KAAK,IAAI,UAAU,KAAK,MAAM;AACjD,uBAAmB,KAAK,KAAK,IAAI;AAAA,EACnC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,wBAAwB;AAC5B,QAAI,CAAC,KAAK,IAAI,YAAa;AAE3B,UAAM,UAAU,MAAM,KAAK,IAAI,UAAU,KAAK,eAAe;AAC7D,UAAM,qBAAqB,OAAO;AAAA,EACpC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,WAAW;AACf,UAAM,KAAK,sBAAsB;AACjC,UAAM,KAAK,sBAAsB;AACjC,UAAM,KAAK,sBAAsB;AAAA,EACnC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,WAAW;AACf,QAAI;AACF,YAAM,QAAQ,MAAM,KAAK,IAAI,UAAU,KAAK,eAAe;AAC3D,YAAM,MAAM,cAAc;AAAA,IAC5B,SAAS,IAAI;AAAA,IAEb;AAAA,EACF;AACF;","names":[]}